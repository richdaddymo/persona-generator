<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Persona Generator Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Persona Generator Pro</h1>
    <p class="text-slate-600 mb-6">Jeder nutzt seinen eigenen Gemini API-Key. Der Key bleibt im Browser (localStorage).</p>

    <div class="bg-white rounded-xl shadow p-5 space-y-4">
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Gemini API-Key</label>
        <input id="apiKey" type="password" class="w-full border rounded-lg p-3 bg-slate-50" placeholder="AIza...">
        <p class="text-xs text-slate-500 mt-1">Wird nur lokal gespeichert – nicht an deinen Server persistiert.</p>
      </div>

      <div class="grid sm:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Produkt</label>
          <input id="product" class="w-full border rounded-lg p-3 bg-slate-50" placeholder="z. B. KI-Anruftrainer">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Nische</label>
          <input id="niche" class="w-full border rounded-lg p-3 bg-slate-50" placeholder="z. B. B2B Sales">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Land</label>
          <input id="country" class="w-full border rounded-lg p-3 bg-slate-50" placeholder="Deutschland">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Marktpotenzial</label>
        <input id="potential" type="range" min="1" max="3" value="2" class="w-full">
        <div class="flex justify-between text-xs text-slate-500"><span>Nische</span><span>Standard</span><span>Massenmarkt</span></div>
      </div>

      <div class="flex flex-wrap gap-2">
        <button id="btnAnalyze" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Markt analysieren</button>
        <button id="btnPersona" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">Persona erstellen</button>
        <button id="btnIdeas" class="px-4 py-2 bg-sky-600 text-white rounded-lg">Content-Ideen</button>
        <button id="btnJourney" class="px-4 py-2 bg-amber-600 text-white rounded-lg">Journey</button>
        <button id="btnAngles" class="px-4 py-2 bg-fuchsia-600 text-white rounded-lg">Angles</button>
        <button id="btnReset" class="px-4 py-2 bg-slate-600 text-white rounded-lg">Reset</button>
      </div>

      <div id="msg" class="text-sm text-red-600"></div>
      <div id="loader" class="hidden text-sm text-slate-500">Bitte warten…</div>

      <div id="outAnalyze" class="hidden bg-slate-50 border rounded-lg p-4"></div>
      <div id="outPersona" class="hidden bg-slate-50 border rounded-lg p-4"></div>
      <div id="outIdeas"   class="hidden bg-slate-50 border rounded-lg p-4"></div>
      <div id="outJourney" class="hidden bg-slate-50 border rounded-lg p-4"></div>
      <div id="outAngles"  class="hidden bg-slate-50 border rounded-lg p-4"></div>
    </div>
  </div>

  <script>
  // === Konfiguration ===
  const API_URL = "https://ibrahim-mohamed.kesug.com/api/proxy.php";

  // Kleine Länder-Map (für Demo ausreichend)
  const countryCodes = {
    "deutschland":"DE","germany":"DE","österreich":"AT","austria":"AT",
    "schweiz":"CH","switzerland":"CH","ägypten":"EG","egypt":"EG",
    "usa":"US","united states":"US"
  };

  // === Hilfen ===
  const el = id => document.getElementById(id);
  const show = (id, on) => el(id).classList.toggle('hidden', !on);
  function err(m){ el('msg').textContent = m || ''; }
  function busy(on){ show('loader', on); }

  // API-Key speichern
  el('apiKey').value = localStorage.getItem('geminiKey') || '';
  el('apiKey').addEventListener('input', e => localStorage.setItem('geminiKey', e.target.value.trim()));

  // Einheitlicher Proxy-Call
  async function proxy(action, body) {
    const apiKey = el('apiKey').value.trim();
    if (!apiKey) throw new Error('Bitte deinen Gemini API-Key eingeben.');
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ apiKey, action, ...body })
    });
    const data = await res.json();
    if (!res.ok || data.error) throw new Error(data.error || "Proxy-Fehler");
    return data;
  }

  // Inputs prüfen
  function validate() {
    const product = el('product').value.trim();
    const niche   = el('niche').value.trim();
    const country = el('country').value.trim();
    if (!product || !niche || !country) { throw new Error('Bitte alle Felder ausfüllen.'); }
    return {product, niche, country};
  }

  // Population via Proxy
  async function fetchPopulation(country) {
    const code = (countryCodes[country.toLowerCase()] || 'DE');
    const out = await proxy("population", { countryCode: code });
    return Number(out.population || 0);
  }

  // Zielgruppengröße (wie bei dir)
  function calculateTargetAudience(population, potential) {
    let p;
    if (potential==='1') p = 0.01 + Math.random()*0.02;      // 1–3%
    else if (potential==='3') p = 0.09 + Math.random()*0.11; // 9–20%
    else p = 0.04 + Math.random()*0.04;                      // 4–8%
    return Math.max(1, Math.round(population*p));
  }

  // Renderer
  function renderAnalyze(d){
    el('outAnalyze').innerHTML = `
      <div><b>Potenzial:</b> ${d.potential} (1=Nische, 2=Standard, 3=Massenmarkt)</div>
      <div class="text-slate-600 mt-1"><b>Begründung:</b> ${d.reason}</div>`;
    show('outAnalyze', true);
  }
  function renderPersona(p, population){
    const per = p.persona;
    el('outPersona').innerHTML = `
      <div><b>Zielgruppen-Größe:</b> ${p.zielgruppen_anzahl.toLocaleString('de-DE')}</div>
      <div class="text-slate-600 mt-1"><b>Begründung:</b> ${p.begruendung_zielgruppengroesse}</div>
      <hr class="my-3">
      <div class="grid sm:grid-cols-2 gap-2">
        <div><b>Name:</b> ${per.Name}</div>
        <div><b>Alter:</b> ${per.Alter}</div>
        <div><b>Geschlecht:</b> ${per.Geschlecht}</div>
        <div><b>Standort:</b> ${per.Standort}</div>
        <div class="sm:col-span-2"><b>Beruf:</b> ${per.Beruf}</div>
      </div>
      <div class="mt-2"><b>Pain Points:</b><ul class="list-disc ml-5">${per.PainPoints.map(x=>`<li>${x}</li>`).join('')}</ul></div>
      <div class="mt-2"><b>Ad Copies:</b>
        <div>LinkedIn: ${per.AdCopies.LinkedIn}</div>
        <div>Meta: ${per.AdCopies.Meta}</div>
        <div>TikTok: ${per.AdCopies.TikTok}</div>
      </div>
      <div class="mt-2"><b>Hashtags/Keywords:</b>
        <div>Instagram: ${p.socialMediaKeywords.Instagram.join(', ')}</div>
        <div>TikTok: ${p.socialMediaKeywords.TikTok.join(', ')}</div>
        <div>Facebook: ${p.socialMediaKeywords.Facebook.join(', ')}</div>
        <div>YouTube: ${p.socialMediaKeywords.YouTube.join(', ')}</div>
      </div>
      ${population ? `<div class="mt-3 text-sm text-slate-600">Anteil an Bevölkerung: ${((p.zielgruppen_anzahl/population)*100).toFixed(2)}%</div>` : ''}`;
    show('outPersona', true);
  }
  function renderIdeas(d){
    const i = d.contentIdeas;
    const block = (t, arr) => `<div><h4 class="font-semibold">${t}</h4><ul class="list-disc ml-5">${arr.map(x=>`<li><b>${x.title}</b> – ${x.description}</li>`).join('')}</ul></div>`;
    el('outIdeas').innerHTML = `<div class="grid sm:grid-cols-3 gap-4">${block('Blog',i.blog)}${block('YouTube',i.youtube)}${block('TikTok',i.tiktok)}</div>`;
    show('outIdeas', true);
  }
  function renderJourney(d){
    const j = d.customerJourney;
    const col = (t, a) => `<div><h4 class="font-semibold">${t}</h4><ul class="list-disc ml-5">${a.map(x=>`<li><b>${x.channel}:</b> ${x.description}</li>`).join('')}</ul></div>`;
    el('outJourney').innerHTML = `<div class="grid sm:grid-cols-3 gap-4">${col('Awareness',j.awareness)}${col('Consideration',j.consideration)}${col('Conversion',j.conversion)}</div>`;
    show('outJourney', true);
  }
  function renderAngles(d){
    el('outAngles').innerHTML = d.marketingAngles.map(a => `<div class="mb-2"><b>${a.angle_name}:</b> ${a.hook_text}</div>`).join('');
    show('outAngles', true);
  }

  // Buttons
  el('btnAnalyze').addEventListener('click', async ()=>{
    err(''); show('outAnalyze', false);
    try {
      const v = validate();
      const out = await proxy("analyzeMarket", { language: 'Deutsch', ...v });
      renderAnalyze(out);
    } catch(e){ err(e.message); }
  });

  let fullPersona=null, population=0;

  el('btnPersona').addEventListener('click', async ()=>{
    err(''); show('outPersona', false);
    try {
      const v = validate();
      population = await fetchPopulation(v.country);
      const potential = el('potential').value;
      const target = calculateTargetAudience(population, potential);
      const out = await proxy("generatePersona", { language:'Deutsch', potential, targetAudience: target, ...v });
      fullPersona = out;
      renderPersona(out, population);
    } catch(e){ err(e.message); }
  });

  el('btnIdeas').addEventListener('click', async ()=>{
    err(''); show('outIdeas', false);
    try {
      if (!fullPersona) throw new Error('Bitte zuerst die Persona erstellen.');
      const out = await proxy("contentIdeas", { language:'Deutsch', persona: fullPersona.persona });
      renderIdeas(out);
    } catch(e){ err(e.message); }
  });

  el('btnJourney').addEventListener('click', async ()=>{
    err(''); show('outJourney', false);
    try {
      if (!fullPersona) throw new Error('Bitte zuerst die Persona erstellen.');
      const product = el('product').value.trim();
      const out = await proxy("journey", { language:'Deutsch', product, persona: fullPersona.persona });
      renderJourney(out);
    } catch(e){ err(e.message); }
  });

  el('btnAngles').addEventListener('click', async ()=>{
    err(''); show('outAngles', false);
    try {
      if (!fullPersona) throw new Error('Bitte zuerst die Persona erstellen.');
      const product = el('product').value.trim();
      const out = await proxy("angles", { language:'Deutsch', product, painPoints: fullPersona.persona.PainPoints });
      renderAngles(out);
    } catch(e){ err(e.message); }
  });

  el('btnReset').addEventListener('click', ()=>{
    err('');
    ['product','niche','country'].forEach(id=>el(id).value='');
    ['outAnalyze','outPersona','outIdeas','outJourney','outAngles'].forEach(id=>show(id,false));
    fullPersona=null; population=0;
  });
  </script>
</body>
</html>
